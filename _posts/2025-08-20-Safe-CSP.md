---
layout: single
title: "[Dreamhack] Safe CSP write-up"
date: 2025-08-20 20:05 +0900
categories: 
    - WEB-write-up
tag:
typora-root-url: ../
toc: true
toc_sticky: true
toc_label: ëª©ì°¨
author_profile: true
comment: true
sidebar:
    nav: "docs"
---

## [Dreamhack] Safe CSP

### ğŸ˜ ë¬¸ì œ ì„¤ëª…

- Google says this CSP is safe.

![img](https://dreamhack-media.s3.amazonaws.com/attachments/c341b2e5603282cb5f47bb80e55a982dd0e093a9a35ef8eef7406e366b991efc.png)

<br>

### âœï¸ í’€ì´

ë¬¸ì œì— ì ‘ì†í•˜ë©´ ë¡œê·¸ì¸ í¼ê³¼ /login ê²½ë¡œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ëœë‹¤.

![image-20250820200636559](/images/2025-08-20-Safe-CSP/image-20250820200636559.png)

<br>

ì†ŒìŠ¤ ì½”ë“œì—ì„œ USER_DATAì— adminì´ ì•„ë‹Œ userì˜ ê³„ì •ì´ ì¡´ì¬í•œë‹¤. ë˜í•œ NONCE ê°’ë„ base64ë¡œ ì•”í˜¸í™”ë˜ì–´ ìˆëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```python
NONCE = base64.b64encode(random.getrandbits(32).to_bytes(8, 'big')).decode()

USER_DATA = {
    "admin": "[**redacted**]",
    "user": "pass"
}
```

<br>

user ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ í•´ë³´ë©´ /memo ê²½ë¡œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ê³  adminì´ ì•„ë‹ˆë¼ê³  ë‚˜ì˜¨ë‹¤.

![image-20250820201342296](/images/2025-08-20-Safe-CSP/image-20250820201342296.png)

<br>

ì†ŒìŠ¤ ì½”ë“œì—ì„œ read_url í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ admin ê³„ì •ì˜ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì½ì„ ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```python
def read_url(url, cookie={"name": "name", "value": "value"}):
    cookie.update({"domain": "127.0.0.1"})
    try:
        service = Service(executable_path="/usr/local/bin/chromedriver")
        options = webdriver.ChromeOptions()
        for _ in [
            "headless",
            "window-size=1920x1080",
            "disable-gpu",
            "no-sandbox",
            "disable-dev-shm-usage",
        ]:
            options.add_argument(_)
        driver = webdriver.Chrome(service=service, options=options)
        driver.implicitly_wait(3)
        driver.set_page_load_timeout(3)
        driver.get("http://127.0.0.1:8000/")
        driver.add_cookie({'name': 'username', 'value': 'admin'})
        driver.add_cookie(cookie)
        driver.get(url)
    except Exception as e:
        driver.quit()
        return False
    driver.quit()
    return True
```

<br>

check_xss í•¨ìˆ˜ì—ì„œëŠ” /memo ê²½ë¡œì—ì„œ text íŒŒë¼ë¯¸í„° ê°’ì„ urlì¸ì½”ë”©í•˜ì—¬ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ urlì„ ì½ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ì•„ë˜ add_header í•¨ìˆ˜ëŠ” CSPë¥¼ ì„¤ì •í•˜ê³  ìˆë‹¤.

```python
def check_xss(param, cookie={"name": "name", "value": "value"}):
    url = f"http://127.0.0.1:8000/memo?text={urllib.parse.quote(param)}"
    return read_url(url, cookie)

@app.after_request
def add_header(response):
    global NONCE
    response.headers[
        "Content-Security-Policy"
    ] = f"default-src 'self';base-uri 'none';style-src 'none';img-src *;script-src 'nonce-{NONCE}'"
    return response
```

<br>

/memo ê²½ë¡œì—ì„œëŠ” usernameì˜ ì¿ í‚¤ ê°’ì„ ê°€ì ¸ì™€ì„œ username ê°’ì„ ê°€ì ¸ì™€ adminì´ ì•„ë‹ˆë¼ë©´ `you are not admin` ë¬¸ìì—´ì„ ì¶œë ¥í•œë‹¤. ë˜í•œ text íŒŒë¼ë¯¸í„°ë„ ê°’ì„ ê°€ì ¸ì™€ xor ì•”í˜¸í™”ë¥¼ í•˜ì—¬ ì¶œë ¥í•´ì£¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```python
@app.route('/memo')
def memo():
    username = request.cookies.get('username')
    memo_text = request.args.get('text', '')
    
    if not username or username not in USER_DATA:
        return redirect('/login')

    if username != 'admin':
        return 'You are not admin!!!'

    try:
        r = random.getrandbits(32)
        memo_bytes = memo_text.encode('utf-8')
        memo_int = bytes_to_long(memo_bytes)
        xor_result = memo_int ^ r
        xor_hex = hex(xor_result)
    except Exception as e:
        xor_hex = f"Conversion fail: {e}"

    resp = make_response(render_template("memo.html", username=username, memo_text=memo_text, xor_result=xor_hex))
    return resp
```

<br>

usernameì˜ ì¿ í‚¤ ê°’ì„ adminìœ¼ë¡œ ë³€ê²½í•´ì£¼ë©´ ì•„ë˜ì™€ ê°™ì´ `Welcome, admin` ë¬¸ìì—´ê³¼ memoë¥¼ ì…ë ¥í•  ìˆ˜ ìˆëŠ” í¼ì´ ë‚˜ì˜¨ë‹¤.

![image-20250820202819213](/images/2025-08-20-Safe-CSP/image-20250820202819213.png)

![image-20250820202740848](/images/2025-08-20-Safe-CSP/image-20250820202740848.png)

<br>

testë¥¼ ì…ë ¥í•˜ì—¬ ìš”ì²­í•´ë³´ë©´, ì…ë ¥í•œ ê°’ì´ text íŒŒë¼ë¯¸í„°ì— í¬í•¨ë˜ì–´ ìš”ì²­ë˜ê³  ì•„ë˜ì—ëŠ” ì…ë ¥í•œ ê°’ê³¼ ì•”í˜¸í™”ëœ ê°’ì´ ì¶œë ¥ëœë‹¤.

![image-20250820202933846](/images/2025-08-20-Safe-CSP/image-20250820202933846.png)

<br>

ì†ŒìŠ¤ ì½”ë“œì—ì„œëŠ” /debug ë¼ìš°í„° ê²½ë¡œì—ì„œë„ param íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ì„œ ì¿ í‚¤ê°€ flagì¸ ê°’ìœ¼ë¡œ ì‹œë„í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```python
@app.route('/debug')
def debug():
    global NONCE
    param = request.args.get('param', '')
    if not check_xss(param, {'name': 'flag', 'value': FLAG.strip()}):
        return f'<script nonce={NONCE}>alert("wrong??");history.go(-1);</script>'

    return f'<script nonce={NONCE}>alert("good");history.go(-1);</script>'
```

<br>

memo.htmlì—ì„œ ë³´ë©´ memo_text ë¶€ë¶„ ì˜†ì— safeê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ë° ì´ëŠ” ì´ìŠ¤ì¼€ì´í”„ë¥¼ ì„¤ì •í•˜ì§€ ì•ŠëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— XSSê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

```html
  {% if memo_text %}
    <p><strong>Memo:</strong> {{ memo_text | safe }}</p>
    <p><strong>Encrypted:</strong> {{ xor_result }}</p>
  {% endif %}
```

<br>

logout ë¶€ë¶„ì˜ ì†ŒìŠ¤ ì½”ë“œì™€ ì‘ë‹µ í—¤ë” ë¶€ë¶„ì˜ CSPë¥¼ ì¶”ê°€í•˜ëŠ” ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³´ë©´ ë¡œê·¸ì•„ì›ƒí•˜ê¸° ì „ê¹Œì§€ Nonce ê°’ì´ ê³„ì† ì‘ë‹µí—¤ë”ì— ë‚˜íƒ€ë‚˜ê³  ì¬ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— Nonceê°’ì„ ì¬ì‚¬ìš©í•´ì„œ script íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ ê°’ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

```python
@app.route('/logout', methods=['POST'])
def logout():
    global NONCE
    random.seed(time.time())
    NONCE = base64.b64encode(random.getrandbits(32).to_bytes(8, 'big')).decode()

    resp = make_response(redirect('/login'))
    resp.delete_cookie('username')
    return resp
```

<br>

ì•„ë˜ nonceê°’ì„ í™•ì¸í•˜ì—¬ /debug ê²½ë¡œì—ì„œ ì¿ í‚¤ê°’ì„ flag ê°’ìœ¼ë¡œ ì„¤ì •í•˜ê³  ìˆê¸° ë•Œë¬¸ì— param íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ì„œ script íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ XSS í˜ì´ë¡œë“œë¥¼ ì‘ì„±í•˜ë©´ ëœë‹¤. ì£¼ì˜í• ì ì€ nonce ê°’ì—ì„œ +ê°€ í¬í•¨ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì¸ì½”ë”©í•˜ì—¬ %2bë¡œ ë³´ë‚´ì•¼í•œë‹¤.

![image-20250820223348898](/images/2025-08-20-Safe-CSP/image-20250820223348898.png)

![image-20250820224157985](/images/2025-08-20-Safe-CSP/image-20250820224157985.png)

![image-20250820224140306](/images/2025-08-20-Safe-CSP/image-20250820224140306.png)